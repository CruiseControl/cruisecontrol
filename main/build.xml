<!--********************************************************************************
 * CruiseControl, a Continuous Integration Toolkit                              *
 * Copyright (C) 2001  ThoughtWorks, Inc.                                       *
 * 651 W Washington Ave. Suite 500                                              *
 * Chicago, IL 60661 USA                                                        *
 *                                                                              *
 * This program is free software; you can redistribute it and/or                *
 * modify it under the terms of the GNU General Public License                  *
 * as published by the Free Software Foundation; either version 2               *
 * of the License, or (at your option) any later version.                       *
 *                                                                              *
 * This program is distributed in the hope that it will be useful,              *
 * but WITHOUT ANY WARRANTY; without even the implied warranty of               *
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                *
 * GNU General Public License for more details.                                 *
 *                                                                              *
 * You should have received a copy of the GNU General Public License            *
 * along with this program; if not, write to the Free Software                  *
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.  *
 *****************************************************************************-->
<project name="CruiseControl" default="all">

    <property file="cruise-build.properties" />   
    <property name="build.compiler" value="jikes" />
    <property name="classes" value="classes"/>        
    <property name="webinfclasses" value="web-inf\classes"/>
    <property name="dist" value="dist"/>
    <property name="lib" value="lib"/>
    <property name="src" value="src"/>
    <property name="test" value="test"/>
    <property name="docs" value="docs"/>
    <property name="apidocs" value="${docs}/api"/>
    <property name="images" value="images"/>

    <path id="classpath" >
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" />
    <target name="init">     
        <mkdir dir="${classes}"/>
        <mkdir dir="${dist}"/>
        <mkdir dir="${apidocs}"/>
        <property name="junit.results" value="test-results.xml" />
    </target>
    
    <target name="clean">
       <delete dir="${dist}"/>
       <mkdir dir="${dist}"/>
       <delete dir="${classes}"/>
       <mkdir dir="${classes}"/>
    </target>
    
    <target name="compile" depends="init">
        <javac srcdir="${src}" destdir="${classes}" classpathref="classpath" />
        <copy todir="${classes}">
            <fileset dir="${src}" includes="**/*.properties"/>
        </copy>
    </target>
  
    <target name="test" depends="init">
        <mkdir dir="test-results" />
        <javac srcdir="${test}" destdir="${classes}" classpathref="classpath" />

        <junit haltonfailure="true" >
            <classpath >
                <path refid="classpath" />
                <pathelement location="${classes}" />
            </classpath>
            <formatter type="plain" usefile="false" />
            <formatter type="xml" usefile="true" />
            <batchtest todir="test-results" >
                <fileset dir="${classes}" includes="**/*Test.class" />
            </batchtest>
        </junit>

        <junitreport tofile="${junit.results}" >
            <fileset dir="./test-results" />
        </junitreport>
        <delete dir="test-results" />
    </target>
    
    <target name="jar">
        <jar jarfile="${dist}\cruisecontrol.jar">
            <fileset dir="${classes}"/>
            <fileset dir="." includes="${docs}/**, ${src}/**" excludes="${src}/**/*.properties"/>
        </jar>
    </target>
    
    <target name="buildwar">
        <javac srcdir="${src}" destdir="${classes}" classpath="${classpath}"/>
        <war warfile="${dist}\buildservlet.war" webxml="web.xml">
           <lib dir="${lib}">
              <include name="servlet.jar"/>
              <include name="xerces.jar"/>
              <include name="xalan.jar"/>
           </lib>
           <classes dir="${classes}">
              <include name="net/sourceforge/cruisecontrol/BuildServlet*"/>
           </classes>
           <fileset dir=".">
              <include name="${images}/**"/>
              <include name="cruisecontrol.xsl"/>
           </fileset>
        </war>
    </target>
    
                                                          
<!-- ***** JAVADOC ***** -->

    <target name="javadoc" depends="init">
       <javadoc sourcepath="${src}" destdir="${apidocs}" packagenames="net.sourceforge.cruisecontrol.*">
           <classpath>
               <path refid="classpath" />
               <pathelement location="${src}" />
           </classpath>
       </javadoc>
    </target>
                                                          
    <target name="all" depends="init,clean,compile,test,javadoc,jar,buildwar" />

<!-- ***** CRUISE EXAMPLES ***** -->

    <target name="cvs-update" depends="init" if="localCopy">
        <cvs cvsroot=":pserver:anonymous@cvs.cruisecontrol.sourceforge.net:/cvsroot/cruisecontrol"
             package="cruisecontrol" dest="${localCopy}" />
    </target>

    <target name="cruise-check" depends="init" if="localCopy" >
        <tstamp />
        <property name="modificationset.file" value="modifications.xml" />
        <taskdef name="modificationset" classname="net.sourceforge.cruisecontrol.ModificationSet" />

        <modificationset lastbuild="${lastGoodBuildTime}" quietperiod="300">
            <cvselement cvsroot=":pserver:anonymous@cvs.cruisecontrol.sourceforge.net:/cvsroot/cruisecontrol" 
                        localworkingcopy="${localCopy}/cruisecontrol" />
        </modificationset>
    </target>

    <target name="cruise" depends="init,cruise-check" >
        <antcall target="cvs-update" />
        <ant antfile="${localCopy}/cruisecontrol/build.xml" target="all" />
    </target>

    <target name="cruise-clean" depends="init,cruise-check" >
        <antcall target="cvs-update" />
        <ant antfile="${localCopy}/cruisecontrol/build.xml" target="clean" />
        <ant antfile="${localCopy}/cruisecontrol/build.xml" target="all" />
    </target>
</project>                                                                       
