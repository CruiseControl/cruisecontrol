<!-- build the release -->
<project name="release" default="release">

    <property name="label" value="2.2-dev"/>

    <target name="release" depends="clean, website, zip, bin-zip"/>

    <target name="clean">
        <delete dir="target" failonerror="false" />
    </target>

    <target name="build">
        <ant inheritAll="false" dir="main"/>
        <ant inheritAll="false" dir="reporting/jsp">
            <property name="user.log.dir" value="logs"/>
            <property name="user.build.status.file" value="status.txt"/>
            <property name="cruise.build.artifacts.dir" value=""/>
        </ant>
    </target>

    <target name="website">
        <fixcrlf srcdir="."
            eol="lf"
            eof="remove"
            includes="**/*.sh"
            />

        <fixcrlf srcdir="."
            eol="crlf"
            includes="**/*.bat"
            />

        <delete dir="target/website" failonerror="no" />
        <mkdir dir="target/website/reporting/jsp"/>
        <copy todir="target/website">
            <fileset dir="docs"/>
        </copy>
        <copy todir="target/website/main">
            <fileset dir="main/docs"/>
        </copy>
        <copy todir="target/website/reporting/jsp">
            <fileset dir="reporting/jsp/docs"/>
        </copy>

        <replace dir="target/website" token="%%VERSION%%" value="${label}">
            <include name="**/*.html"/>
        </replace>
        <replace dir="target/website" token="../main/docs/" value="main/">
            <include name="**/*.html"/>
        </replace>
        <replace dir="target/website" token="../reporting/jsp/docs/" value="reporting/jsp/">
            <include name="**/*.html"/>
        </replace>

        <replace dir="target/website/main" token="../../docs/" value="../">
            <include name="**/*.html"/>
        </replace>

        <replace dir="target/website/reporting/jsp" token="../../../docs/" value="../../">
            <include name="**/*.html"/>
        </replace>
    </target>

    <target name="zip" depends="build">
        <mkdir dir="target/zip"/>
        <copy todir="target/zip" overwrite="true" >
            <fileset dir=".">
                <exclude name="target**"/>
                <exclude name="main/lib/starteam-sdk.jar"/>
                <exclude name="main/target/**"/>
                <exclude name="reporting/jsp/samplelogs/_cache/**"/>
                <exclude name="reporting/jsp/target/**"/>
                <exclude name="reporting/jsp/testresults.xml"/>
                <exclude name="release*"/>
                <exclude name="**/binaryrelease/**"/>
            </fileset>
        </copy>
        <replace dir="target/zip" token="%%VERSION%%" value="${label}">
            <include name="**/*.html"/>
        </replace>

        <zip zipfile="target/cruisecontrol-${label}.zip">
            <zipfileset dir="target/zip" prefix="cruisecontrol-${label}"/>                
        </zip>
    </target>

    <target name="bin-zip" depends="build" >
        <defaultexcludes remove="**/CVS"/>
        <defaultexcludes remove="**/CVS/**"/>
        <defaultexcludes remove="**/.cvsignore"/>

        <zip destfile="target/cruisecontrol-bin-${label}.zip">
            <zipfileset dir="binaryrelease" prefix="cruisecontrol-bin-${label}" excludes="*.zip" />
            <zipfileset src="binaryrelease/jakarta-commons-math.zip" prefix="cruisecontrol-bin-${label}/projects"/>
            <zipfileset src="binaryrelease/apache-ant-1.6.3.zip" prefix="cruisecontrol-bin-${label}"/>
            <zipfileset dir="main/lib" includes="*.jar" prefix="cruisecontrol-bin-${label}/lib"/>
            <zipfileset file="main/lib/ant/ant.jar" prefix="cruisecontrol-bin-${label}/lib"/>
            <zipfileset file="main/lib/ant/ant-launcher.jar" prefix="cruisecontrol-bin-${label}/lib"/>
            <zipfileset file="main/dist/cruisecontrol.jar" prefix="cruisecontrol-bin-${label}/lib"/>
        </zip>

    </target>
</project>
