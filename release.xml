<!-- build the release -->
<project name="release" default="release">

    <property file="build.properties"/>

    <!-- use a local variable to make sure that a script that would read the
         properties file would still be capable of overidding this one -->
    <property name="cc.release.label" value="${cc.version}"/>

    <target name="release" depends="clean, website, zip, bin-zip"/>

    <target name="checklabel">
        <fail unless="cc.release.label" message="label is not defined."/>
    </target>

    <target name="clean">
        <delete dir="target" failonerror="false"/>
    </target>

    <target name="build">
        <ant inheritAll="false" dir="main"/>
        <ant inheritAll="false" dir="reporting/jsp">
            <property name="user.log.dir" value="logs"/>
            <property name="user.build.status.file" value="status.txt"/>
            <property name="cruise.build.artifacts.dir" value="artifacts"/>
        </ant>
    </target>

    <target name="website" depends="checklabel">
        <fixcrlf srcdir="."
            eol="lf"
            eof="remove"
            includes="**/*.sh"
            />

        <fixcrlf srcdir="."
            eol="crlf"
            includes="**/*.bat"
            />

        <delete dir="target/website" failonerror="no"/>
        <mkdir dir="target/website/reporting/jsp"/>
        <copy todir="target/website">
            <fileset dir="docs"/>
        </copy>

        <ant inheritAll="false" dir="main" target="javadoc"/>
        <copy todir="target/website/main">
            <fileset dir="main/docs"/>
        </copy>
        <ant inheritAll="false" dir="reporting/jsp" target="javadoc"/>
        <copy todir="target/website/reporting/jsp">
            <fileset dir="reporting/jsp/docs"/>
        </copy>

        <replace dir="target/website" token="%%VERSION%%" value="${cc.release.label}">
            <include name="**/*.html"/>
        </replace>

        <replace dir="target/website" token="../main/docs/" value="main/">
            <include name="**/*.html"/>
        </replace>
        <replace dir="target/website" token="../reporting/jsp/docs/" value="reporting/jsp/">
            <include name="**/*.html"/>
        </replace>

        <replace dir="target/website/main" token="../../docs/" value="../">
            <include name="**/*.html"/>
        </replace>

        <replace dir="target/website/reporting/jsp" token="../../../docs/" value="../../">
            <include name="**/*.html"/>
        </replace>
    </target>

    <target name="zip" depends="checklabel,build">
        <mkdir dir="target/zip"/>
        <copy todir="target/zip" overwrite="true">
            <fileset dir=".">
                <include name="**/*.html"/>
                <exclude name="**/target/**"/>
                <exclude name="reporting/jsp/samplelogs/_cache/**"/>
                <exclude name="release*"/>
                <exclude name="**/binaryrelease/**"/>
                <exclude name=".pc/**"/>
            </fileset>
        </copy>
        <replace dir="target/zip" token="%%VERSION%%" value="${cc.release.label}">
            <include name="**/*.html"/>
        </replace>

        <property name="cc.zip.prefix" value="cruisecontrol-${cc.release.label}"/>
        <zip zipfile="target/cruisecontrol-${cc.release.label}.zip">
            <zipfileset dir="target/zip" prefix="${cc.zip.prefix}"/>
            <zipfileset dir="." prefix="${cc.zip.prefix}">
                <exclude name="**/*.html"/>
                <exclude name="**/target/**"/>
                <exclude name="reporting/jsp/samplelogs/_cache/**"/>
                <exclude name="reporting/jsp/testresults.xml"/>
                <exclude name="release*"/>
                <exclude name="**/binaryrelease/**"/>
                <exclude name=".pc/**"/>
            </zipfileset>
        </zip>
    </target>

    <target name="bin-zip" depends="build">
        <defaultexcludes remove="**/CVS"/>
        <defaultexcludes remove="**/CVS/**"/>
        <defaultexcludes remove="**/.cvsignore"/>

        <copy todir="target/binzip">
            <fileset file="binaryrelease/README.txt"/>
        </copy>
        <replace dir="target/binzip" token="%%VERSION%%" value="${cc.release.label}">
            <include name="**/*"/>
        </replace>

        <property name="cc.zip.prefix" value="cruisecontrol-bin-${cc.release.label}"/>
        <zip destfile="target/cruisecontrol-bin-${cc.release.label}.zip">
            <zipfileset dir="binaryrelease" prefix="${cc.zip.prefix}">
                <exclude name="README.txt"/>
                <exclude name="*.zip"/>
                <exclude name="**/CVS"/>
                <exclude name="**/CVS/**"/>
                <exclude name="**/.cvsignore"/>
            </zipfileset>
            <zipfileset file="target/binzip/README.txt" prefix="${cc.zip.prefix}"/>
            <zipfileset src="binaryrelease/jakarta-commons-math.zip" prefix="${cc.zip.prefix}/projects"/>
            <zipfileset src="binaryrelease/apache-ant-1.6.3.zip" prefix="${cc.zip.prefix}"/>
            <zipfileset dir="main/lib" includes="*.jar" prefix="${cc.zip.prefix}/lib"/>
            <zipfileset dir="main/lib/licenses" includes="*.txt" prefix="${cc.zip.prefix}/lib/licenses"/>
            <zipfileset file="main/lib/ant/ant.jar" prefix="${cc.zip.prefix}/lib"/>
            <zipfileset file="main/lib/ant/ant-launcher.jar" prefix="${cc.zip.prefix}/lib"/>
            <zipfileset file="main/dist/cruisecontrol.jar" prefix="${cc.zip.prefix}/lib"/>
            <zipfileset src="reporting/jsp/dist/cruisecontrol.war" prefix="${cc.zip.prefix}/webapps/cruisecontrol"/>
            <zipfileset dir="target/website" prefix="${cc.zip.prefix}/docs"/>
        </zip>

    </target>
</project>
